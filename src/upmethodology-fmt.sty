% Layout and Pagraph Format for Unified Process Methodology
%
% Copyright (c) 2006-2009, 2012-2013 Stephane GALLAND <galland@arakhne.org>
% 
% This program is free library; you can redistribute it and/or modify
% it under the terms of the GNU Lesser General Public License as
% published by the Free Software Foundation; either version 3 of the
% License, or any later version.
%
% This library is distributed in the hope that it will be useful, but
% WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
% Lesser General Public License for more details.
%
% You should have received a copy of the GNU Lesser General Public
% License along with this library; see the file COPYING.  If not,
% write to the Free Software Foundation, Inc., 59 Temple Place - Suite
% 330, Boston, MA 02111-1307, USA.

\global\edef\upm@package@fmt@ver{2013/08/27}

\NeedsTeXFormat{LaTeX2e}[1995/12/01]
\ProvidesPackage{upmethodology-fmt}[\upm@package@fmt@ver]

\RequirePackage{upmethodology-p-common}

\gdef\upm@fmt@force@single@spacing#1{{\begin{singlespace}#1\end{singlespace}}}
\gdef\upm@date@head#1/#2\@nil{#1}
\gdef\upm@date@tail#1/#2\@nil{#2}
\gdef\upm@date@first#1{{\expandafter\upm@date@head#1\expandafter\@nil}}
\gdef\upm@date@second#1{{\expandafter\expandafter\expandafter\upm@date@head\expandafter\upm@date@tail#1\expandafter\@nil\expandafter\expandafter\expandafter\@nil}}
\gdef\upm@date@third#1{{\expandafter\expandafter\expandafter\upm@date@tail\expandafter\upm@date@tail#1\expandafter\@nil\expandafter\expandafter\expandafter\@nil}}

%----------------------------------------
% LOCALES
%----------------------------------------
\global\let\upm@format@lang@extractyear\upm@date@first%
\def\upm@format@lang@english{%
  \gdef\upm@lang@@{\message{**** upmethodology-fmt is using English language ****}}%
  \global\renewcommand{\upm@format@lang@makedate}[3]{##3\string/\two@digits{##2}\string/\two@digits{##1}}%
  \global\let\upm@format@lang@extractyear\upm@date@first%
  \global\let\upm@format@lang@extractmonth\upm@date@second%
  \gdef\upm@format@lang@professor{Pr.}%
  \gdef\upm@format@lang@doctor{Dr.}%
  \gdef\upm@format@lang@phdoctor{Ph.D.}%
  \gdef\upm@format@lang@scdoctor{Sc.D.}%
  \gdef\upm@format@lang@mdoctor{M.D.}%
  \gdef\upm@format@lang@professionalengineer{CEng.}%
  \gdef\upm@format@lang@incorporatedengineer{IEng.}%
}
\def\upm@format@lang@french{%
  \gdef\upm@lang@@{\message{**** upmethodology-fmt is using French language ****}}%
  \global\renewcommand{\upm@format@lang@makedate}[3]{\two@digits{##1}\string/\two@digits{##2}\string/##3}%
  \global\let\upm@format@lang@extractyear\upm@date@third%
  \global\let\upm@format@lang@extractmonth\upm@date@second%
  \global\let\upm@format@lang@extractday\upm@date@first%
  \gdef\upm@format@lang@professor{Pr.}%
  \gdef\upm@format@lang@doctor{Dr.}%
  \gdef\upm@format@lang@phdoctor{Ph.D.}%
  \gdef\upm@format@lang@scdoctor{Sc.D.}%
  \gdef\upm@format@lang@mdoctor{M.D.}%
  \gdef\upm@format@lang@professionalengineer{Ing.}%
  \gdef\upm@format@lang@incorporatedengineer{Ing.}%
}
\global\providecommand{\upm@format@lang@makedate}[3]{}%

%----------------------------------------
% OPTIONS
%----------------------------------------
\DeclareOption{french}{%
  \upm@format@lang@french
  \PassOptionsToPackage{french}{varioref}
}
\DeclareOption{francais}{%
  \upm@format@lang@french
  \PassOptionsToPackage{french}{varioref}
}
\DeclareOption{english}{%
  \upm@format@lang@english
  \PassOptionsToPackage{english}{varioref}
}
\ExecuteOptions{english}
\ProcessOptions
\upm@lang@@


\RequirePackage{graphicx}
\RequirePackage{subfigure}
\RequirePackage{tabularx}
\RequirePackage{multicol}
\RequirePackage{colortbl}
\RequirePackage{picinpar}
\RequirePackage{amsmath}
\RequirePackage{amsthm}
\RequirePackage{pifont}
\RequirePackage{setspace}
\RequirePackage{varioref}
\RequirePackage{txfonts}
\RequirePackage{relsize}
\RequirePackage{xkeyval}
\RequirePackage{hyphenat}

%----------------------------------------
% Exponent and indice
%----------------------------------------
% Exponent
%\newcommand{\textsup}[1]{\ensuremath{^{\text{#1}}}\xspace}
\newcommand{\textsup}[1]{\upm@textsuperscript{#1}\xspace}
% Indice
%\newcommand{\textsub}[1]{\ensuremath{_{\text{#1}}}\xspace}
\newcommand{\textsub}[1]{\upm@textsubscript{#1}\xspace}

%----------------------------------------
% Major Emphazing
%----------------------------------------
\newcommand{\Emph}[1]{\textbf{#1}\xspace}

%----------------------------------------
% SYMBOLS
%----------------------------------------
\renewcommand{\copyright}{\Pisymbol{psy}{211}\xspace}
\newcommand{\trademark}{\Pisymbol{psy}{228}\xspace}
\newcommand{\regmark}{\Pisymbol{psy}{226}\xspace}
\newcommand{\smalltrade}{{\tiny\trademark}\xspace}
\newcommand{\smallreg}{{\tiny\regmark}\xspace}
\newcommand{\smallcopy}{{\tiny\copyright}\xspace}
\newcommand{\ust}{\textsup{st}}
\newcommand{\und}{\textsup{nd}}
\newcommand{\urd}{\textsup{rd}}
\newcommand{\uth}{\textsup{th}}

%----------------------------------------
% DEFAULT GRAPHICX CONFIGURATION
%----------------------------------------

\DeclareGraphicsExtensions{.pdf,.png,.jpg,.jpeg,.tiff,.gif}
\graphicspath{{./}}

%----------------------------------------
% FIGURES
%----------------------------------------

\newcommand{\upm@mfigure}[5][ht]{
	\begin{figure}[#1]%
		\begin{center}%
			\includegraphics[#2]{#3}%
			\caption{#4}%
			\label{fig:#5}%
		\end{center}%
	\end{figure}%
}
\newcommand{\upm@mfigurestar}[5][ht]{
	\begin{figure*}[#1]%
		\begin{center}%
			\includegraphics[#2]{#3}%
			\caption{#4}%
			\label{fig:#5}%
		\end{center}%
	\end{figure*}%
}
%-----
%\mfigure[position]{options}{filename}{caption}{label}
\def\mfigure{\@ifstar\upm@mfigurestar\upm@mfigure}
%-----
%\figref{label}
\newcommand{\figref}[1]{\ref{fig:#1}}
%-----
%\figpageref{label}
\newcommand{\figpageref}[1]{\pageref{fig:#1}}

%-----
% Multi-figures

\newcounter{upm@subfigure@count}

\newcommand{\upm@beginsubfigure}[4]{
	\let\upm@mfiguresaved\mfigure
	%options,filename,caption,label
	\renewcommand{\mfigure}[5][]{
		\xdef\upm@tmp@subfigure@label{\alph{upm@subfigure@count}}%
                \subfigure[##4]{%
			\includegraphics[##2]{##3}%
			\label{fig:##5}%
			\label{fig:#4:\upm@tmp@subfigure@label}%
		}%
		\addtocounter{upm@subfigure@count}{1}%
	}
	%options,filename,caption
	\newcommand{\msubfigure}[3]{
		\xdef\upm@tmp@subfigure@label{\alph{upm@subfigure@count}}%
                \subfigure[##3]{%
			\includegraphics[##1]{##2}%
			\label{fig:#4:\upm@tmp@subfigure@label}%
		}%
		\addtocounter{upm@subfigure@count}{1}%
	}
	\setcounter{upm@subfigure@count}{1}
	\gdef\upm@mfigurescaption{#3}%
	\gdef\upm@mfigureslabel{fig:#4}%
	\begin{#1}[#2]\centering %
}

\newcommand{\upm@endsubfigure}[1]{
		\caption{\upm@mfigurescaption}%
		\label{\upm@mfigureslabel}%
	\end{#1}%
	\let\mfigure\upm@mfiguresaved
}

%-----
%\mfigures[position]{caption}{label}
\newenvironment{mfigures}[3][ht]{
	\upm@beginsubfigure{figure}{#1}{#2}{#3}%
}{%
	\upm@endsubfigure{figure}%
}
%-----
%\mfigures*[position]{caption}{label}
\newenvironment{mfigures*}[3][ht]{
	\upm@beginsubfigure{figure*}{#1}{#2}{#3}%
}{%
	\upm@endsubfigure{figure*}%
}

%----------------------------------------
% IMAGES INCLUDING TeX EXPRESSIONS
%----------------------------------------

%
% This section is copied from the AutoLaTeX package
% http://www.arakhne.org/autolatex
%

%-----
%\DeclareGraphicsExtensionsWtex{coma separated extensions}
\providecommand{\DeclareGraphicsExtensionsWtex}[1]{%
	\xdef\@autolatex@wtfig@extensions{\zap@space#1 \@empty}%
}
\DeclareGraphicsExtensionsWtex{.pdftex_t,.pstex_t,.pdf_tex,.ps_tex}

\providecommand{\@autolatex@wtfig@searchinpath}[1]{%
	\IfFileExists{#1}{%
		\protected@edef\@autolatex@wtfig@tmp{\protect\resizebox{\@autolatex@wtfig@width}{\@autolatex@wtfig@height}{\protect\input{#1}}}%
	}{%
		\@for\@autolatex@wtfig@pathtmp:=\Ginput@path\do{%
			\ifx\@autolatex@wtfig@tmp\relax%
				\IfFileExists{\@autolatex@wtfig@pathtmp#1}{%
					\protected@edef\@autolatex@wtfig@tmp{\protect\resizebox{\@autolatex@wtfig@width}{\@autolatex@wtfig@height}{\protect\input{\@autolatex@wtfig@pathtmp#1}}}%
				}{}%
			\fi%
		}%
	}%
}

\define@key[autolatex]{withtex}{width}{%
	\gdef\@autolatex@wtfig@width{#1}%
}
\define@key[autolatex]{withtex}{height}{%
	\gdef\@autolatex@wtfig@height{#1}%
}

%-----
%\includefigurewtex[width=xx,height=yy]{filename}
\providecommand{\includefigurewtex}[2][width=\linewidth]{%
	\begingroup%
	\gdef\@autolatex@wtfig@width{!}%
	\gdef\@autolatex@wtfig@height{!}%
	\setkeys[autolatex]{withtex}{#1}%
	%
	\global\let\@autolatex@wtfig@tmp\relax%
	\global\let\@autolatex@wtfig@ext\relax%
	\global\let\@autolatex@wtfig@path\relax%
	\filename@parse{#2}%
	\ifx\filename@ext\relax%
		\@for\@autolatex@wtfig@exttmp:=\@autolatex@wtfig@extensions\do{%
			\@autolatex@wtfig@searchinpath{#2\@autolatex@wtfig@exttmp}%
		}%
	\else%
		\@autolatex@wtfig@searchinpath{#2\@autolatex@wtfig@exttmp}%
	\fi%
	%
	\ifx\@autolatex@wtfig@tmp\relax%
		\errmessage{Package upmethodology-fmt: File not found '#2', needed for figure inclusion}%
	\else%
		\@autolatex@wtfig@tmp%
	\fi%
	%
	\endgroup%
}

\global\let\includegraphicswtex\includefigurewtex

%----------------------------------------
% ENVIRONMENT FOR IMAGES INCLUDING TeX EXPRESSIONS
%----------------------------------------

\gdef\upm@figtex@dyncaption@remove{}
\gdef\upm@figtex@figremove#1{%
	\global\expandafter\let\csname FIG#1\endcsname\relax%
}
\gdef\upm@figtex@restore{%
	\upm@figtex@dyncaption@remove%
	\gdef\upm@figtex@dyncaption@remove{}
}
%-----
%\figmath{id}{content}
\def\figmath#1#2{%
	\expandafter\gdef\csname FIG#1\endcsname{\ensuremath{#2}}%
	\global\protected@edef\upm@figtex@dyncaption@remove{\upm@figtex@dyncaption@remove\protect\upm@figtex@figremove{#1}}%
}
%-----
%\figtext{id}{content}
\def\figtext#1#2{%
	\expandafter\gdef\csname FIG#1\endcsname{#2}%
	\global\protected@edef\upm@figtex@dyncaption@remove{\upm@figtex@dyncaption@remove\protect\upm@figtex@figremove{#1}}%
}

\let\upm@fmt@figtex@nil\@nil
\def\upm@fmt@figtex@parseparams#1=#2\upm@fmt@figtex@nil{\gdef\@tmp{#2}}

\newcommand{\upm@mfigurewtex}[5][ht]{
	\begin{figure}[#1]%
		\begin{center}%
			% Providing an ascendent compatibility on the second parameter:
			% - Prefered value of the parameter: a list of key/value pairs;
			% - Old fashion value of the parameter: the value for the "width" key.
			{\upm@fmt@figtex@parseparams #2====\upm@fmt@figtex@nil}%
			\ifthenelse{\equal{\@tmp}{===}}{%
				\includegraphicswtex[width=#2]{#3}%
			}{%
				\includegraphicswtex[#2]{#3}%
			}%
			\caption{#4}%
			\label{fig:#5}%
		\end{center}%
	\end{figure}%
	\upm@figtex@restore%
}
\newcommand{\upm@mfigurewtexstar}[5][ht]{
	\begin{figure*}[#1]%
		\begin{center}%
			% Providing an ascendent compatibility on the second parameter:
			% - Prefered value of the parameter: a list of key/value pairs;
			% - Old fashion value of the parameter: the value for the "width" key.
			{\upm@fmt@figtex@parseparams #2====\upm@fmt@figtex@nil}%
			\ifthenelse{\equal{\@tmp}{===}}{%
				\includegraphicswtex[width=#2]{#3}%
			}{%
				\includegraphicswtex[#2]{#3}%
			}%
			\caption{#4}%
			\label{fig:#5}%
		\end{center}%
	\end{figure*}%
	\upm@figtex@restore%
}
%-----
%\mfigurewtex[position]{options}{filename}{caption}{label}
\def\mfigurewtex{\@ifstar\upm@mfigurewtexstar\upm@mfigurewtex}



%----------------------------------------
% TABLES
%----------------------------------------

%table's colors
\definecolor{backtableheader}{rgb}{0.92,0.94,1}
\definecolor{fronttableheader}{rgb}{0.23,0.33,0.48}
%title of a table
\def\upm@fmt@table@title#1{\color{fronttableheader} \cellcolor{backtableheader} {\bfseries #1}}
%title of columns
\def\upm@fmt@table@column@title#1{\hfil{\color{fronttableheader} \cellcolor{backtableheader} {\itshape#1}}\hfil}

% Utility functions for mtabular
\newcounter{upm@fmt@mtabular@columnnumber}

\gdef\upm@fmt@mtabular@expandtitle#1#2{%
	\multicolumn{#1}{|c|}{\upm@fmt@table@title{\ignorespaces#2\ignorespaces}}%
}

\newcommand{\tabulartitlespec}[1]{%
	\gdef\upm@fmt@mtabular@expandtitle##1##2{%
		\multicolumn{##1}{#1}{\upm@fmt@table@title{\ignorespaces##2\ignorespaces}}%
	}
}

%-----
%\mtabular[width]{ncolumns}{columns}
\newenvironment{mtabular}[3][\linewidth]{%
	\newcommand{\tabulartitle}[1]{%
		\hline%
		\upm@fmt@mtabular@expandtitle{#2}{##1} \\%
		\hline%
	}%
	\newcommand{\tabulartitleinside}[1]{%
		\hline\hline%
		\upm@fmt@mtabular@expandtitle{#2}{##1} \\%
		\hline%
	}%
	\newcommand*{\upm@fmt@mtabular@column@next}[1]{%
		& \upm@fmt@table@column@title{\ignorespaces##1\ignorespaces}%
		\addtocounter{upm@fmt@mtabular@columnnumber}{-1}%
		\ifnum0<\value{upm@fmt@mtabular@columnnumber}%
			\let\upm@fmt@mtabular@column@continue\upm@fmt@mtabular@column@next%
		\else%
			\\ \hline \let\upm@fmt@mtabular@column@continue\relax%
		\fi%
		\upm@fmt@mtabular@column@continue%
	}
	\newcommand*{\upm@fmt@mtabular@column@first}[1]{%
		\upm@fmt@table@column@title{\ignorespaces##1\ignorespaces}%
		\addtocounter{upm@fmt@mtabular@columnnumber}{-1}%
		\ifnum0<\value{upm@fmt@mtabular@columnnumber}%
			\let\upm@fmt@mtabular@column@continue\upm@fmt@mtabular@column@next%
		\else%
			\\ \hline \let\upm@fmt@mtabular@column@continue\relax%
		\fi%
		\upm@fmt@mtabular@column@continue%
	}
	\newcommand{\tabularheader}{%
		\setcounter{upm@fmt@mtabular@columnnumber}{#2}%
		\upm@fmt@mtabular@column@first%
	}%
	\newcommand{\tabularrowheader}[1]{%
		\centering\upm@fmt@table@column@title{\ignorespaces##1}%
	}%
	\begingroup\tabularx{#1}{#3}%
}{%
	\endtabularx\endgroup%
}

%-----
%\mtable[position]{width}{ncolumns}{columns}{caption}{label}
\newenvironment{mtable}[6][ht]{%
	\gdef\upm@table@caption{#5}%
	\xdef\upm@table@label{tab:#6}%
	\gdef\upm@table@note{}%
	\newcommand{\captionastitle}{\tabulartitle{\upm@table@caption}}%
	\newcommand{\tablenote}[1]{\gdef\upm@table@note{\bgroup ##1\egroup}}%
	\table[#1]%
	\center%
	\mtabular[#2]{#3}{#4}%
}{%
	\endmtabular\relax%
	\caption{\upm@table@caption}%
	\label{\upm@table@label}%
	\endcenter%
	\upm@table@note%
	\endtable%
	\global\let\upm@table@caption\relax%
	\global\let\upm@table@label\relax%
	\global\let\upm@table@note\relax%
}

%-----
%\tabref{label}
\newcommand{\tabref}[1]{\ref{tab:#1}}
%-----
%\tabpageref{label}
\newcommand{\tabpageref}[1]{\pageref{tab:#1}}

%----------------------------------------
% PARAGRAPHS
%----------------------------------------
\setlength{\parindent}{0pt}
\setlength{\parskip}{.2cm}

%----------------------------------------
% COLORIZED SECTION'S TITLES
%----------------------------------------

% PRIVATE COLORS
\definecolor{sectiontitlecolor}{rgb}{0.93,0.41,0}
\definecolor{chaptertitlecolor}{rgb}{0.24,0.33,0.48}
\definecolor{parttitlecolor}{rgb}{0.24,0.33,0.48}

% PRIVATE FORMATTING MACROS
\newcounter{upm@format@section@sectionlevel}
\setcounter{upm@format@section@sectionlevel}{0}

\gdef\upm@format@partnum#1{\textcolor{parttitlecolor}{\expandafter\fontsize{40pt}{60pt}\selectfont#1\normalfont}}
\gdef\upm@format@parttitle#1{\textcolor{parttitlecolor}{\huge\scshape #1}}
\gdef\upm@format@chapternum#1{\textcolor{chaptertitlecolor}{\expandafter\fontsize{40pt}{60pt}\selectfont#1\normalfont}}
\gdef\upm@format@chaptertitle#1{\textcolor{chaptertitlecolor}{\Huge\scshape #1}}
\gdef\upm@format@sectionnum#1#2{\textcolor{sectiontitlecolor}{#2}}
\gdef\upm@format@sectiontitle#1#2{\textcolor{sectiontitlecolor}{#2}}

% PART
\ifupmbookformat
	\gdef\@part[#1]#2{%
	    \ifnum \c@secnumdepth >-2\relax
	      \refstepcounter{part}%
	      \addcontentsline{toc}{part}{\thepart\hspace{1em}#1}%
	    \else
	      \addcontentsline{toc}{part}{#1}%
	    \fi
	    \markboth{}{}%
	    {\huge\centering
	     \interlinepenalty \@M
	     \normalfont
	     \ifnum \c@secnumdepth >-2\relax
	       \upm@format@partnum{\thepart}
	       \par
	       \vskip 20\p@
	     \fi
	     \upm@format@parttitle{\nohyphens{#2}}\par}%
	    \@endpart}
	\gdef\@spart#1{%
	    {\centering
	     \interlinepenalty \@M
	     \normalfont
	     \upm@format@parttitle{\nohyphens{#1}}\par}%
	    \@endpart}
\fi

% CHAPTER
\ifupmarticleformat\else
	\newcommand{\upm@format@makechapterhead}[2]{%
		  %\vspace*{50\p@}%
		  {\parindent \z@ \Huge \raggedleft \normalfont
		    \ifx\@empty#1\ifnum \c@secnumdepth >\m@ne
			\upm@format@chapternum{\thechapter}
			\par\nobreak
			\vskip 20\p@
		    \fi\fi
		    \interlinepenalty\@M
		    %\ifupmbookformat\doublespacing\fi
		    \upm@format@chaptertitle{\nohyphens{#2}}\par\nobreak
		    \vskip 80\p@
		  }
	}
	%internal implementation of \chapter
	\gdef\@makechapterhead#1{\upm@format@makechapterhead{\@empty}{#1}}
	%internal implementation of \chapter*
	\gdef\@makeschapterhead#1{\upm@format@makechapterhead{\relax}{#1}}
\fi

% SECTIONS
\let\upm@format@sect@old\@sect
\let\upm@format@ssect@old\@ssect

% public implementation of sections.
\renewcommand{\section}{\setcounter{upm@format@section@sectionlevel}{1}\@startsection{section}{1}{\z@}{-3.5ex \@plus -1ex \@minus -.2ex}{2.3ex \@plus.2ex}{\normalfont\Large\scshape}}
\renewcommand{\subsection}{\setcounter{upm@format@section@sectionlevel}{2}\@startsection{subsection}{2}{\z@}{-3.25ex\@plus -1ex \@minus -.2ex}{1.5ex \@plus .2ex}{\normalfont\large\scshape}}
\renewcommand{\subsubsection}{\setcounter{upm@format@section@sectionlevel}{3}\@startsection{subsubsection}{3}{\z@}{-3.25ex\@plus -1ex \@minus -.2ex}{1.5ex \@plus .2ex}{\normalfont\normalsize\scshape}}

% internal implementations for sections.
\gdef\@sect#1#2#3#4#5#6[#7]#8{\upm@format@sect@old{#1}{#2}{#3}{#4}{#5}{#6}[#7]{\upm@format@sectiontitle{\theupm@format@section@sectionlevel}{#8}}}
\gdef\@ssect#1#2#3#4#5{\upm@format@ssect@old{#1}{#2}{#3}{#4}{\upm@format@sectiontitle{\theupm@format@section@sectionlevel}{#5}}}
\gdef\@seccntformat#1{\upm@format@sectionnum{\theupm@format@section@sectionlevel}{\csname the#1\endcsname/}\quad}

%----------------------------------------
% PAGE LAYOUT
%----------------------------------------

% Update the format of the saved pages and sections
\renewcommand{\sectionmark}[1]{\markright{\thesection\ \textsc{#1}}}
\ifupmarticleformat\else
\renewcommand{\chaptermark}[1]{\markboth{\textsc{#1}}{}}
\renewcommand{\@mkboth}[2]{%
    \let\upm@doc@MakeUppercase\MakeUppercase%
    \gdef\MakeUppercase##1{##1}%
    \chaptermark{#1}%
    \let\MakeUppercase\upm@doc@MakeUppercase%
    \let\upm@doc@MakeUppercase\relax%
}
\fi
% Make sure that the page before a part or
% a chapter title was empty
\renewcommand{\cleardoublepage}{%
  \clearpage%
  \if@twoside\ifodd\c@page%
  \else%
  \thispagestyle{facingtochapter}%
  \hbox{}\newpage%
  \if@twocolumn\hbox{}\newpage%
  \fi\fi\fi%
}
\newcommand{\ps@facingtochapter}{\ps@empty}

%----------------------------------------
% ADDITIONAL SECTIONS
%----------------------------------------

\gdef\upm@format@newsection@alignment{}

%-----
% Part without number but inside the TOC
%\parttoc [toctitle]{title} % left-alignment inside TOC
%\parttoc*[toctitle]{title} % right-alignment inside TOC
\def\parttoc{\@ifstar%
	{\gdef\upm@format@newsection@alignment{\protect\numberline{}}\expandafter\upm@format@newsection@part}%
	{\gdef\upm@format@newsection@alignment{}\expandafter\upm@format@newsection@part}}
\def\upm@format@newsection@part{\@ifnextchar [%
	{\expandafter\upm@format@newsection@part@opt}%
	{\expandafter\upm@format@newsection@part@nopt}}
\def\upm@format@newsection@part@opt[#1]#2{%
	\part*{#2\addcontentsline{toc}{part}{\upm@format@newsection@alignment{#1}}}%
	\chaptermark{}%
}
\def\upm@format@newsection@part@nopt#1{%
	\part*{#1\addcontentsline{toc}{part}{\upm@format@newsection@alignment{#1}}}%
	\chaptermark{}%
}

%-----
% Chapter without number but inside the TOC
%\chaptertoc [toctitle]{title} % left-alignment inside TOC
%\chaptertoc*[toctitle]{title} % right-alignment inside TOC
\def\chaptertoc{\@ifstar%
	{\gdef\upm@format@newsection@alignment{\protect\numberline{}}\expandafter\upm@format@newsection@chapter}%
	{\gdef\upm@format@newsection@alignment{}\expandafter\upm@format@newsection@chapter}}
\def\upm@format@newsection@chapter{\@ifnextchar [%
	{\expandafter\upm@format@newsection@chapter@opt}%
	{\expandafter\upm@format@newsection@chapter@nopt}}
\def\upm@format@newsection@chapter@opt[#1]#2{%
	\@schapter{#2\addcontentsline{toc}{chapter}{\upm@format@newsection@alignment{#1}}}%
	\chaptermark{#1}%
}
\def\upm@format@newsection@chapter@nopt#1{%
	\@schapter{#1\addcontentsline{toc}{chapter}{\upm@format@newsection@alignment{#1}}}%
	\chaptermark{#1}%
}

%-----
% Section without number but inside the TOC
%\sectiontoc [toctitle]{title} % left-alignment inside TOC
%\sectiontoc*[toctitle]{title} % right-alignment inside TOC
\def\sectiontoc{\@ifstar%
	{\gdef\upm@format@newsection@alignment{\protect\numberline{}}\expandafter\upm@format@newsection@section}%
	{\gdef\upm@format@newsection@alignment{}\expandafter\upm@format@newsection@section}}
\def\upm@format@newsection@section{\@ifnextchar [%
	{\expandafter\upm@format@newsection@section@opt}%
	{\expandafter\upm@format@newsection@section@nopt}}
\def\upm@format@newsection@section@opt[#1]#2{%
	\section*{#2\addcontentsline{toc}{section}{\upm@format@newsection@alignment{#1}}}%
}
\def\upm@format@newsection@section@nopt#1{%
	\section*{#1\addcontentsline{toc}{section}{\upm@format@newsection@alignment{#1}}}%
}

%-----
% Subsection without number but inside the TOC
%\subsectiontoc [toctitle]{title} % left-alignment inside TOC
%\subsectiontoc*[toctitle]{title} % right-alignment inside TOC
\def\subsectiontoc{\@ifstar%
	{\gdef\upm@format@newsection@alignment{\protect\numberline{}}\expandafter\upm@format@newsection@subsection}%
	{\gdef\upm@format@newsection@alignment{}\expandafter\upm@format@newsection@subsection}}
\def\upm@format@newsection@subsection{\@ifnextchar [%
	{\expandafter\upm@format@newsection@subsection@opt}%
	{\expandafter\upm@format@newsection@subsection@nopt}}
\def\upm@format@newsection@subsection@opt[#1]#2{%
	\subsection*{#2\addcontentsline{toc}{subsection}{\upm@format@newsection@alignment{#1}}}%
}
\def\upm@format@newsection@subsection@nopt#1{%
	\subsection*{#1\addcontentsline{toc}{subsection}{\upm@format@newsection@alignment{#1}}}%
}

%-----
% Subsubsection without number but inside the TOC
%\subsubsectiontoc [toctitle]{title} % left-alignment inside TOC
%\subsubsectiontoc*[toctitle]{title} % right-alignment inside TOC
\def\subsubsectiontoc{\@ifstar%
	{\gdef\upm@format@newsection@alignment{\protect\numberline{}}\expandafter\upm@format@newsection@subsubsection}%
	{\gdef\upm@format@newsection@alignment{}\expandafter\upm@format@newsection@subsubsection}}
\def\upm@format@newsection@subsubsection{\@ifnextchar [%
	{\expandafter\upm@format@newsection@subsubsection@opt}%
	{\expandafter\upm@format@newsection@subsubsection@nopt}}
\def\upm@format@newsection@subsubsection@opt[#1]#2{%
	\subsubsection*{#2\addcontentsline{toc}{subsubsection}{\upm@format@newsection@alignment{#1}}}%
}
\def\upm@format@newsection@subsubsection@nopt#1{%
	\subsubsection*{#1\addcontentsline{toc}{subsubsection}{\upm@format@newsection@alignment{#1}}}%
}

%----------------------------------------
% BIBLIOGRAPHY
%----------------------------------------

%-----
%\bibsize{size}
\newcommand{\bibsize}[1]{\gdef\upm@bibsize{#1}}

\gdef\upm@bibsize{\small}

\gdef\@biblabel#1{{\upm@bibsize{[#1]}}}

\gdef\@lbibitem[#1]#2{\item[\@biblabel{#1}\hfill]\upm@bibsize\if@filesw{%
	\let\protect\noexpand\immediate\write\@auxout{\string\bibcite{#2}{#1}}}\fi\ignorespaces}

\gdef\@bibitem#1{\item\upm@bibsize\if@filesw%
	\immediate\write\@auxout{\string\bibcite{#1}{\the\value{\@listctr}}}\fi\ignorespaces}


%----------------------------------------
% TABLE OF CONTENT
%----------------------------------------
\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}

%----------------------------------------
% ENUMERATIONS
%----------------------------------------
\newcounter{upm@fmt@savedcounter}

\newcommand{\savecounter}[1]{%
	\setcounter{upm@fmt@savedcounter}{\value{#1}}%
}
\newcommand{\restorecounter}[1]{%
	\setcounter{#1}{\theupm@fmt@savedcounter}%
}
\newcommand{\saveenumcounter}{\savecounter{\@enumctr}}
\newcommand{\restoreenumcounter}{\restorecounter{\@enumctr}}
\newcommand{\setenumcounter}[1]{\setcounter{\@enumctr}{#1}\addtocounter{\@enumctr}{-1}}
\newcommand{\getenumcounter}{\value{\@enumctr}}

%----------------------------------------
% FOOTNOTE
%----------------------------------------

\gdef\upm@footnoteref#1{\upm@textsuperscript{#1}}
\gdef\upm@footnotepageref#1#2{\upm@textsuperscript{{#1\tiny(#2)}}}

\def\upm@savefootnote#1#2{%
	\footnote{#1\label{\upm@protect{footnote:#2}}}%
	\upm@nameundef{footnote:#2:cmd}%
}
\def\upm@savefootnotestar#1#2{%
	\upm@namedef{footnote:#2:cmd}{\upm@savefootnote{#1}{#2}}%
}

\DeclareRobustCommand\savefootnote{\@ifstar\upm@savefootnotestar\upm@savefootnote}

\def\upm@reffootnote#1{%
	\upm@ifdefinedname{footnote:#1:cmd}{%
		\upm@nameuse{footnote:#1:cmd}}{%
		\upm@footnoteref{\upm@getref{\upm@protect{footnote:#1}}}%
	}%
	\xspace%
} 
\def\upm@reffootnotestar#1{%
	\upm@ifdefinedname{footnote:#1:cmd}{%
		\upm@nameuse{footnote:#1:cmd}}{%
		\xdef\upm@tmp@tmp{\upm@protect{footnote:#1}}%
		\upm@footnotepageref{\expandafter\upm@getref{\upm@tmp@tmp}}{\expandafter\upm@getpageref{\upm@tmp@tmp}}%
		\global\let\upm@tmp@tmp\relax%
	}%
	\xspace%
} 

\DeclareRobustCommand\reffootnote{\@ifstar\upm@reffootnotestar\upm@reffootnote}

%----------------------------------------
% IMAGES IN PARAGRAPHS
%----------------------------------------

\newenvironment{umlinpar}[2][width=.45\linewidth]{%
\begin{window}[0,r,{\mbox{\hspace{.5cm}\includegraphics[#1]{#2}\vspace{.5cm}}},{}]
}{%
\end{window}}

%----------------------------------------
% DATE
%----------------------------------------

%Build a date this a supported format
%\makedate{day}{month}{year}
\let\makedate\upm@format@lang@makedate

%-----
%Replies the year corresponding to the given supported date
%\extractyear{date}
\let\extractyear\upm@format@lang@extractyear

%-----
%Replies the month corresponding to the given supported date
%\extractmonth{date}
\let\extractmonth\upm@format@lang@extractmonth

%-----
%Replies the day corresponding to the given supported date
%\extractday{date}
\let\extractday\upm@format@lang@extractday

% Redefine the today function
\AtBeginDocument{\global\edef\today{\makedate{\the\day}{\the\month}{\the\year}}}

%----------------------------------------
% PEOPLE NAME
%----------------------------------------

\newcommand{\makenamespacing}[1]{%
	\expandafter\upm@foreach.\in#1\do{%
		\ignorespaces\upm@foreach@term.\,%
	}{%
		\ignorespaces\upm@foreach@term\xspace%
	}%
	\ignorespaces
}

\newcommand{\makenametest}[2]{\makenamespacing{#1} #2}

%\upmmakename[von]{firstname}{lastname}{separator}
\newcommand{\upmmakename}[4][\relax]{%
	\ifx#1\relax%
		{\mbox{\smaller \makenamespacing{#2}}#4\textsc{\ignorespaces#3}}%
	\else%
		{\mbox{\smaller \makenamespacing{#2}}#4\mbox{\smaller #1}#4\textsc{\ignorespaces#3}}%
	\fi%
}

%\makename[von]{firstname}{lastname}
\newcommand{\makename}[3][\relax]{%
	\upmmakename[#1]{#2}{#3}{\ }%
}

\gdef\upm@format@people@title#1{\textsc{#1}}

%\prname[von]{firstname}{lastname}
%\prname*[von]{firstname}{lastname}
\def\prname{\@ifstar\upm@prnamestar\upm@prname}
\newcommand{\upm@prname}[3][\relax]{%
	\upm@format@people@title{\upm@format@lang@professor}~\upmmakename[#1]{#2}{#3}{\ }%
}
\newcommand{\upm@prnamestar}[3][\relax]{%
	\upmmakename[#1]{#2}{#3}{\ }, \upm@format@people@title{\upm@format@lang@professor}%
}

%\drname[von]{firstname}{lastname}
%\drname*[von]{firstname}{lastname}
\def\drname{\@ifstar\upm@drnamestar\upm@drname}
\newcommand{\upm@drname}[3][\relax]{%
	\upm@format@people@title{\upm@format@lang@doctor}~\upmmakename[#1]{#2}{#3}{\ }%
}
\newcommand{\upm@drnamestar}[3][\relax]{%
	\upmmakename[#1]{#2}{#3}{\ }, \upm@format@people@title{\upm@format@lang@doctor}%
}

%\phdname[von]{firstname}{lastname}
%\phdname*[von]{firstname}{lastname}
\def\phdname{\@ifstar\upm@phdnamestar\upm@phdname}
\newcommand{\upm@phdname}[3][\relax]{%
	\upm@format@people@title{\upm@format@lang@phdoctor}~\upmmakename[#1]{#2}{#3}{\ }%
}
\newcommand{\upm@phdnamestar}[3][\relax]{%
	\upmmakename[#1]{#2}{#3}{\ }, \upm@format@people@title{\upm@format@lang@phdoctor}%
}

%\scdname[von]{firstname}{lastname}
%\scdname*[von]{firstname}{lastname}
\def\scdname{\@ifstar\upm@scdnamestar\upm@scdname}
\newcommand{\upm@scdname}[3][\relax]{%
	\upm@format@people@title{\upm@format@lang@scdoctor}~\upmmakename[#1]{#2}{#3}{\ }%
}
\newcommand{\upm@scdnamestar}[3][\relax]{%
	\upmmakename[#1]{#2}{#3}{\ }, \upm@format@people@title{\upm@format@lang@scdoctor}%
}

%\mdname[von]{firstname}{lastname}
%\mdname*[von]{firstname}{lastname}
\def\mdname{\@ifstar\upm@mdnamestar\upm@mdname}
\newcommand{\upm@mdname}[3][\relax]{%
	\upm@format@people@title{\upm@format@lang@mdoctor}~\upmmakename[#1]{#2}{#3}{\ }%
}
\newcommand{\upm@mdnamestar}[3][\relax]{%
	\upmmakename[#1]{#2}{#3}{\ }, \upm@format@people@title{\upm@format@lang@mdoctor}%
}

%\pengname[von]{firstname}{lastname}
%\pengname*[von]{firstname}{lastname}
\def\pengname{\@ifstar\upm@pengnamestar\upm@pengname}
\newcommand{\upm@pengname}[3][\relax]{%
	\upm@format@people@title{\upm@format@lang@professionalengineer}~\upmmakename[#1]{#2}{#3}{\ }%
}
\newcommand{\upm@pengnamestar}[3][\relax]{%
	\upmmakename[#1]{#2}{#3}{\ }, \upm@format@people@title{\upm@format@lang@professionalengineer}%
}

%\iengname[von]{firstname}{lastname}
%\iengname*[von]{firstname}{lastname}
\def\iengname{\@ifstar\upm@iengnamestar\upm@iengname}
\newcommand{\upm@iengname}[3][\relax]{%
	\upm@format@people@title{\upm@format@lang@incorporatedengineer}~\upmmakename[#1]{#2}{#3}{\ }%
}
\newcommand{\upm@iengnamestar}[3][\relax]{%
	\upmmakename[#1]{#2}{#3}{\ }, \upm@format@people@title{\upm@format@lang@incorporatedengineer}%
}

%----------------------------------------
% INLINE ENUMERATION
%----------------------------------------

\newcounter{@@upm@fmt@inlineenumeration}
\newcommand{\inlineenumerationlabel}[1]{(#1)}
\let\upm@fmt@inlineenum@numberformat\roman
\newenvironment{inlineenumeration}{%
	\begingroup%
	\let\upm@fmt@inlineenum@currentlabel\@currentlabel%
	\renewcommand{\item}{\xdef\@currentlabel{\upm@fmt@inlineenum@numberformat{@@upm@fmt@inlineenumeration}}{\inlineenumerationlabel{\@currentlabel}{\addtocounter{@@upm@fmt@inlineenumeration}{1}}}~}%
	\setcounter{@@upm@fmt@inlineenumeration}{1}%
}{%
	\global\let\@currentlabel\upm@fmt@inlineenum@currentlabel%
	\endgroup%
}

%----------------------------------------
% DESCRIPTION LIST WITH NUMBERS
%----------------------------------------

\newcounter{@upm@fmt@enumdescription@cnt@}
\newcommand{\upm@fmt@enumdescription@fmt@}[1]{}
\newcommand{\enumdescriptionlabel}[1]{\textbf{#1}}
\newenvironment{enumdescriptionx}[3][i]{%
	\begingroup\setcounter{@upm@fmt@enumdescription@cnt@}{1}%
	\let\upm@fmt@enumdescription@savedlabel\@currentlabel%
	\ifthenelse{\equal{#1}{a}}{%
		\renewcommand{\upm@fmt@enumdescription@fmt@}[1]{#2\alph{##1}#3}%
	}{%
		\ifthenelse{\equal{#1}{i}}{%
			\renewcommand{\upm@fmt@enumdescription@fmt@}[1]{#2\roman{##1}#3}%
		}{%
			\renewcommand{\upm@fmt@enumdescription@fmt@}[1]{#2\expandafter{\csname the##1\endcsname}#3}%
		}%
	}%
	\begin{list}{}{%
		\renewcommand{\makelabel}[1]{\xdef\@currentlabel{\upm@fmt@enumdescription@fmt@{@upm@fmt@enumdescription@cnt@}}\enumdescriptionlabel{\@currentlabel~-~##1}:~{\addtocounter{@upm@fmt@enumdescription@cnt@}{1}}}%
		\settowidth{\labelwidth}{iii)~}%
	}
}{%
	\global\let\@currentlabel\upm@fmt@enumdescription@savedlabel%
	\end{list}\endgroup%
}
\newenvironment{enumdescription}[1][i]{%
	\begin{enumdescriptionx}[#1]{}{}%
}{%
	\end{enumdescriptionx}%
}

%----------------------------------------
% DESCRIPTION LIST WITH BULLETS
%----------------------------------------
\gdef\upm@fmt@itemizeddescription@separator{\iflanguage{french}{ :}{:}}
\newcommand{\upm@fmt@itemizeddescription@formatdescription}[1]{\textbf{#1}}
\newcommand{\upm@fmt@itemizeddescription@desc}[1]{%
	\upm@fmt@itemizeddescription@formatdescription{#1\upm@fmt@itemizeddescription@separator}\ %
}
\let\upm@fmt@olditem\item
\let\upm@item@param\upm@fmt@olditem
\let\upm@item@noparam\upm@fmt@olditem
\def\item{\@ifnextchar[\upm@item@param\upm@item@noparam}
\renewenvironment{description}[1][]{%
	\begin{itemize}%
	\renewcommand{\upm@item@param}[1][]{\upm@fmt@olditem \upm@fmt@itemizeddescription@desc{##1}}%
	\renewcommand{\upm@item@noparam}{\upm@fmt@olditem }%
}{%
	\end{itemize}%
}

%----------------------------------------
% SIZE MANAGEMENT
%----------------------------------------
\newenvironment{upmfontsize}[1]{%
	\begingroup%
	\let\upm@Huge\Huge%
	\let\upm@huge\huge%
	\let\upm@normalsize\normalsize%
	\let\upm@small\small%
	\let\upm@scriptsize\scriptsize%
	\let\upm@footnotesize\footnotesize%
	\let\upm@tiny\tiny%
	%
	\ifx#1\Huge%
		\let\Huge\upm@Huge%
		\let\huge\upm@Huge%
		\let\small\upm@huge%
		\let\scriptsize\upm@normalsize%
		\let\footnotesize\upm@small%
		\let\tiny\upm@scriptsize%
	\else\ifx#1\huge%
		\let\Huge\upm@Huge%
		\let\huge\upm@Huge%
		\let\small\upm@normalsize%
		\let\scriptsize\upm@small%
		\let\footnotesize\upm@scriptsize%
		\let\tiny\upm@footnotesize%
	\else\ifx#1\small%
		\let\Huge\upm@huge%
		\let\huge\upm@normalsize%
		\let\small\upm@scriptsize%
		\let\scriptsize\upm@footnotesize%
		\let\footnotesize\upm@tiny%
		\let\tiny\upm@tiny%
	\else\ifx#1\scriptsize%
		\let\Huge\upm@normalsize%
		\let\huge\upm@small%
		\let\small\upm@footnotesize%
		\let\scriptsize\upm@tiny%
		\let\footnotesize\upm@tiny%
		\let\tiny\upm@tiny%
	\else\ifx#1\footnotesize%
		\let\Huge\upm@small%
		\let\huge\upm@scriptsize%
		\let\small\upm@tiny%
		\let\scriptsize\upm@tiny%
		\let\footnotesize\upm@tiny%
		\let\tiny\upm@tiny%
	\else\ifx#1\tiny%
		\let\Huge\upm@scriptsize%
		\let\huge\upm@footnotesize%
		\let\small\upm@tiny%
		\let\scriptsize\upm@tiny%
		\let\footnotesize\upm@tiny%
		\let\tiny\upm@tiny%
	\fi%
	\fi%
	\fi%
	\fi%
	\fi%
	\fi%
	#1%
}{\endgroup}

%----------------------------------------
% FRAMED MINIPAGE
%----------------------------------------

\newsavebox{\upm@framed@minipage}
%\begin{framedminipage}{width}...\end{framedminipage}
\newenvironment{framedminipage}[1]{%
	\begin{lrbox}{\upm@framed@minipage}\begin{minipage}{#1}%
	}{%
	\end{minipage}\end{lrbox}\fbox{\usebox{\upm@framed@minipage}}}

%\begin{framedcolorminipage}{width}{border}{background}...\end{framedcolorminipage}
\newenvironment{framedcolorminipage}[3]{%
	\newcommand{\upm@framed@minipage@border}{#2}%
	\newcommand{\upm@framed@minipage@background}{#3}%
	\begin{lrbox}{\upm@framed@minipage}\begin{minipage}{#1}%
	}{%
	\end{minipage}\end{lrbox}\fcolorbox{\upm@framed@minipage@border}{\upm@framed@minipage@background}{\usebox{\upm@framed@minipage}}}

%----------------------------------------
% HIGHLIGH BOXES
%----------------------------------------

\newsavebox{\upm@highlight@box@save}

\newenvironment{upm@highligh@box}[2]{%
	\par
	\vspace{.5cm}
	\begin{tabular}{|p{#1}|}
	\hline
	\begin{window}[0,l,{\mbox{\includegraphics[width=1cm]{#2}}},{}]
}{%
	\end{window}\\ \hline \end{tabular}
	\vspace{.5cm}
	\par
}

\newenvironment{upmcaution}[1][\linewidth]{%
	\upm@highligh@box{#1}{caution.png}%
}{%
	\endupm@highligh@box%
}

\newenvironment{upminfo}[1][\linewidth]{%
	\upm@highligh@box{#1}{info.png}%
}{%
	\endupm@highligh@box%
}

\newenvironment{upmquestion}[1][\linewidth]{%
	\upm@highligh@box{#1}{question.png}%
}{%
	\endupm@highligh@box%
}

%----------------------------------------
% PROVIDE URL MACROS, WHICH WILL BE
% OVERRIDDEN BY THE DOCUMENT CLASS
%----------------------------------------

\newcommand{\url}[2][]{\texttt{#2}}
\newcommand{\href}[3][]{\texttt{#3}}

%----------------------------------------
% Exponents and Indices
%----------------------------------------
\renewcommand{\textup}[1]{\textsuperscript{#1}\xspace}
\def\@textsubscript#1{%
  {\m@th\ensuremath{_{\mbox{\fontsize\sf@size\z@#1}}}}}
\newcommand{\textsubscript}[1]{\@textsubscript{\selectfont#1}}
\newcommand{\textdown}[1]{\textsubscript{#1}\xspace}


%----------------------------------------
% UNDERLINE
%----------------------------------------

\let\upm@oldunderline\underline
\renewcommand{\underline}[1]{\upm@oldunderline{\smash{#1}}}

%----------------------------------------
% ENVIRONMENT FOR DEFINITIONS
%----------------------------------------
\colorlet{definitionbackground}{backtableheader}
\colorlet{definitionheaderforeground}{fronttableheader}
\colorlet{definitionborder}{fronttableheader}
\colorlet{definitiontextforeground}{fronttableheader}

\newtheoremstyle{upmfmtdefinitionstyle}% name of the style to be used
	  {}% measure of space to leave above the theorem. E.g.: 3pt
	  {}% measure of space to leave below the theorem. E.g.: 3pt
	  {}% name of font to use in the body of the theorem
	  {}% measure of space to indent the head
	  {\bfseries}% name of head font
	  {}% punctuation between head and body
	  {\newline}% space after theorem head
	  {\textcolor{definitionheaderforeground}{\thmname{#1}\thmnumber{~#2}\iflanguage{french}{ :}{:}\thmnote{ #3}}\vspace{.25em}}% Manually specify head

\theoremstyle{upmfmtdefinitionstyle}
\iflanguage{french}{
	\newtheorem{upmfmtdefinition}{D\'efinition}
}{
	\newtheorem{upmfmtdefinition}{Definition}
}
\theoremstyle{plain}

\newlength{\upm@fmt@tmp@length}
\newenvironment{definition}[1][]{%
	\setlength{\upm@fmt@tmp@length}{\linewidth}%
	\addtolength{\upm@fmt@tmp@length}{-.65em}%
	\par\vspace{\parsep}\begin{framedcolorminipage}{\upm@fmt@tmp@length}{definitionborder}{definitionbackground}\color{definitiontextforeground}%
	\begin{upmfmtdefinition}[#1]%
}{%
	\end{upmfmtdefinition}%
	\end{framedcolorminipage}\vspace{\parsep}\par%
}
\let\listofdefinitions\listofupmfmtdefinitions


\endinput
